{% extends "base.html" %}
{% block title %}Nieuwe Klacht{% endblock %}
{% block body_class %}page-klacht-aanmaken{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/klacht_aanmaken.css') }}">
{% endblock %}
{% block content %}
<div class="container">
    <div class="header">
        <a href="{{ url_for('main.user_dashboard') }}" class="back-button">Terug naar Dashboard</a>
        <h1 style="font-weight: 600;">Nieuwe Klacht</h1>
    </div>

    <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="card">
        <div class="card-header">
            <h1>Klacht Registreren</h1>
            <p>Vul het formulier in om een nieuwe klacht aan te maken</p>
        </div>

        <div class="card-body">
            <div class="user-info">
                <strong>Ingelogd als:</strong> {{ user_naam }} ({{ session.get('user_rol') }})
            </div>

            <form method="POST" enctype="multipart/form-data">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="businessunit" class="required">Businessunit</label>
                        <select name="businessunit" id="businessunit" required>
                            <option value="">Kies businessunit</option>
                            {% for bu in businessunits %}
                                <option value="{{ bu }}" {% if (request.form.get('businessunit') or session.get('businessunit_naam')) == bu %}selected{% endif %}>{{ bu }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="klant_naam" class="required">Klant</label>
                        <input type="text" name="klant_naam" id="klant_naam" list="klanten_datalist" placeholder="Begin met typen..." value="{{ request.form.get('klant_naam','') }}" required>
                        <input type="hidden" name="klant_id" id="klant_id" value="{{ request.form.get('klant_id','') }}">
                        <datalist id="klanten_datalist">
                            {% for klant in klanten %}
                                <option value="{{ klant.klantnaam }}" data-id="{{ klant.klant_id }}"></option>
                            {% endfor %}
                        </datalist>
                    </div>

                    <div class="form-group full-width">
                        <label for="order_nummer" class="required">Ordernummer</label>
                        <input type="text" name="order_nummer" id="order_nummer" value="{{ request.form.get('order_nummer','') }}" required placeholder="Voer ordernummer in">
                    </div>

                    <div class="form-group">
                        <label for="artikelnummer" class="required">Artikelnummer</label>
                        <input type="text" name="artikelnummer" id="artikelnummer" value="{{ request.form.get('artikelnummer','') }}" required placeholder="Voer artikelnummer in">
                    </div>

                    <div class="form-group">
                        <label for="aantal_eenheden" class="required">Aantal eenheden</label>
                        <input type="number" min="1" step="1" name="aantal_eenheden" id="aantal_eenheden" value="{{ request.form.get('aantal_eenheden','') }}" required placeholder="Aantal">
                    </div>

                    <div class="form-group full-width">
                        <label for="mogelijke_oorzaak">Mogelijke oorzaak</label>
                        <textarea name="mogelijke_oorzaak" id="mogelijke_oorzaak" placeholder="Beschrijf de mogelijke oorzaak van het probleem">{{ request.form.get('mogelijke_oorzaak','') }}</textarea>
                    </div>

                    <div class="form-group full-width">
                        <label for="reden_afwijzing" class="required">Klacht omschrijving</label>
                        <textarea name="reden_afwijzing" id="reden_afwijzing" required placeholder="Omschrijf de klacht">{{ request.form.get('reden_afwijzing','') }}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="categorie_id" class="required">Probleemcategorie</label>
                        <div class="text-muted" style="font-size: 0.9rem; margin-bottom: 4px;">
                            Voorgestelde categorie: <strong id="suggestedCategorieLabel">{{ suggested_categorie_type or 'Andere' }}</strong>
                        </div>
                        <select name="categorie_id" id="categorie_id" required>
                            <option value="">Selecteer een categorie</option>
                            {% for categorie in categorieen %}
                                <option value="{{ categorie.categorie_id }}" {% if selected_categorie_id and selected_categorie_id|int == categorie.categorie_id %}selected{% endif %}>
                                    {{ categorie.type }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label for="bijlage">Bijlage (Foto)</label>
                        <div class="file-upload" id="fileUploadArea">
                            <input type="file" name="bijlage" id="bijlage" accept="image/*,application/pdf" multiple>
                            <label for="bijlage" class="file-upload-label">
                                <div class="upload-icon">&#128247;</div>
                                <div id="fileUploadText">Klik om bestanden te uploaden</div>
                                <div style="font-size: 0.9rem; color: #666;">(Optioneel - JPG, PNG, PDF, etc.)</div>
                            </label>
                        </div>
                        <div id="filePreview" class="file-preview" style="display: none;">
                            <ul id="filesList" style="list-style: none; padding-left: 0; margin: 0;"></ul>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <div class="auto-info">
                            <strong>Automatisch ingevuld:</strong>
                            Status: <strong>Ingediend</strong> |
                            Datum: <strong>Vandaag</strong> |
                            Verantwoordelijke: <strong>{{ user_naam }}</strong>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <a href="{{ url_for('main.user_dashboard') }}">
                        <button type="button" class="btn btn-secondary">Annuleren</button>
                    </a>
                    <button type="submit" class="btn btn-primary">Klacht Indienen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const requiredFields = form.querySelectorAll('[required]');
        const fileInput = document.getElementById('bijlage');
        const filePreview = document.getElementById('filePreview');
        const fileUploadText = document.getElementById('fileUploadText');
        const filesList = document.getElementById('filesList');
        const klantNaamInput = document.getElementById('klant_naam');
        const klantIdHidden = document.getElementById('klant_id');
        const klantDatalist = document.getElementById('klanten_datalist');
        const klachtOmschrijvingInput = document.getElementById('reden_afwijzing');
        const mogelijkeOorzaakInput = document.getElementById('mogelijke_oorzaak');
        const categorieSelect = document.getElementById('categorie_id');
        const suggestedLabel = document.getElementById('suggestedCategorieLabel');
        let suggestTimer;

        function scheduleCategorySuggestion() {
            if (!categorieSelect) return;
            clearTimeout(suggestTimer);
            suggestTimer = setTimeout(fetchCategorySuggestion, 250);
        }

        async function fetchCategorySuggestion() {
            const payload = {
                klacht_omschrijving: klachtOmschrijvingInput ? klachtOmschrijvingInput.value : '',
                mogelijke_oorzaak: mogelijkeOorzaakInput ? mogelijkeOorzaakInput.value : ''
            };

            // Geen request versturen als beide velden leeg zijn
            if (!payload.klacht_omschrijving && !payload.mogelijke_oorzaak) {
                return;
            }

            try {
                const resp = await fetch('{{ url_for("main.suggest_categorie") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    credentials: 'same-origin',
                    body: new URLSearchParams(payload)
                });
                if (!resp.ok) return;
                const suggestedType = (await resp.text()).trim();
                if (suggestedType && categorieSelect) {
                    const match = Array.from(categorieSelect.options).find(opt => opt.text.trim() === suggestedType);
                    if (match) {
                        match.selected = true;
                    }
                    if (suggestedLabel) {
                        suggestedLabel.textContent = suggestedType;
                    }
                }
            } catch (err) {
                console.warn('Kon categorie suggestie niet ophalen', err);
            }
        }

        function renderFileList() {
            filesList.innerHTML = '';
            if (fileInput.files.length === 0) {
                filePreview.style.display = 'none';
                fileUploadText.textContent = 'Klik om bestanden te uploaden';
                return;
            }
            filePreview.style.display = 'block';
            Array.from(fileInput.files).forEach((file, index) => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.alignItems = 'center';
                li.style.justifyContent = 'space-between';
                li.style.padding = '6px 8px';
                li.style.borderBottom = '1px solid rgba(0,0,0,0.04)';
                li.style.fontSize = '14px';
                const name = document.createElement('span');
                name.textContent = file.name;
                const actions = document.createElement('div');
                actions.style.display = 'flex';
                actions.style.gap = '8px';
                if (file.type && file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.style.maxWidth = '60px';
                    img.style.maxHeight = '60px';
                    img.style.borderRadius = '6px';
                    img.style.marginRight = '8px';
                    name.prepend(img);
                }
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = 'Verwijderen';
                removeBtn.style.background = '#ef4444';
                removeBtn.style.color = 'white';
                removeBtn.style.border = 'none';
                removeBtn.style.padding = '6px 10px';
                removeBtn.style.borderRadius = '6px';
                removeBtn.style.cursor = 'pointer';
                removeBtn.onclick = function() {
                    const dt = new DataTransfer();
                    Array.from(fileInput.files).forEach((f, i) => { if (i !== index) dt.items.add(f); });
                    fileInput.files = dt.files;
                    renderFileList();
                };
                actions.appendChild(removeBtn);
                li.appendChild(name);
                li.appendChild(actions);
                filesList.appendChild(li);
            });
        }

        requiredFields.forEach(field => {
            field.addEventListener('blur', function() {
                this.style.borderColor = this.value ? '#10b981' : '#e63946';
            });
        });

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileUploadText.textContent = `${this.files.length} bestand(en) geselecteerd`;
                renderFileList();
            } else {
                filePreview.style.display = 'none';
                fileUploadText.textContent = 'Klik om bestanden te uploaden';
            }
        });

        form.addEventListener('submit', function(e) {
            let isValid = true;
            requiredFields.forEach(field => {
                if (!field.value) {
                    field.style.borderColor = '#e63946';
                    isValid = false;
                }
            });
            if (klantNaamInput && klantDatalist) {
                const match = Array.from(klantDatalist.options).find(opt => opt.value === klantNaamInput.value);
                if (!match) {
                    isValid = false;
                    alert('Kies een klant uit de lijst.');
                } else {
                    klantIdHidden.value = match.dataset.id || '';
                }
            }
            if (!isValid) {
                e.preventDefault();
                alert('Gelieve alle verplichte velden in te vullen (aangegeven met *)');
            }
        });

        if (klantNaamInput) {
            klantNaamInput.addEventListener('change', () => {
                const match = Array.from(klantDatalist.options).find(opt => opt.value === klantNaamInput.value);
                klantIdHidden.value = match ? (match.dataset.id || '') : '';
            });
        }

        if (klachtOmschrijvingInput) {
            klachtOmschrijvingInput.addEventListener('input', scheduleCategorySuggestion);
        }
        if (mogelijkeOorzaakInput) {
            mogelijkeOorzaakInput.addEventListener('input', scheduleCategorySuggestion);
        }
        // Initieel invullen als er al tekst aanwezig is (bij herladen met errors)
        fetchCategorySuggestion();
    });
</script>
{% endblock %}
