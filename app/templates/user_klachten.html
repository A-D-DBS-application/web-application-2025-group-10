{% extends "base.html" %}
{% block title %}Mijn Klachten{% endblock %}
{% block body_class %}page-user-klachten{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_klachten.css') }}">
{% endblock %}
{% block content %}
<div class="container">
    <div class="header">
        <a href="{{ url_for('main.user_dashboard') }}" class="back-button">Terug naar Dashboard</a>
        <h1>Mijn Klachten</h1>
    </div>

    <form method="GET" class="filters">
        <div class="filter-field" style="flex:1; min-width:140px;">
            <label for="klant_filter">Klant</label>
            <input type="text" id="klant_filter" name="klant_naam" list="klanten_filter" value="{{ request.args.get('klant_naam') or '' }}" placeholder="Begin te typen...">
            <input type="hidden" name="klant_id" id="klant_id_filter" value="{{ request.args.get('klant_id') or '' }}">
            <datalist id="klanten_filter">
                {% for klant in klanten %}
                    <option value="{{ klant.klantnaam }}" data-id="{{ klant.klant_id }}"></option>
                {% endfor %}
            </datalist>
        </div>
        <div class="filter-field">
            <label for="categorie_id">Categorie</label>
            <select name="categorie_id" id="categorie_id">
                <option value="">Alle categorieÃ«n</option>
                {% for categorie in categorieen %}
                    <option value="{{ categorie.categorie_id }}" {% if request.args.get('categorie_id') == categorie.categorie_id|string %}selected{% endif %}>{{ categorie.type }}</option>
                {% endfor %}
            </select>
        </div>
        {% if session.get('user_rol') in ['Admin', 'Key user'] %}
        <div class="filter-field" style="min-width:150px;">
            <label for="verantwoordelijke_naam">Verantwoordelijke</label>
            <input type="text" id="verantwoordelijke_naam" name="verantwoordelijke_naam" list="verantwoordelijken_filter" value="{{ request.args.get('verantwoordelijke_naam') or request.args.get('vertegenwoordiger_naam') or '' }}" placeholder="Naam verantwoordelijke">
            <datalist id="verantwoordelijken_filter">
                {% for rep in vertegenwoordigers or [] %}
                    <option value="{{ rep.naam }}"></option>
                {% endfor %}
            </datalist>
        </div>
        {% endif %}
        {% if session.get('user_rol') != 'Key user' %}
        <div class="filter-field">
            <label for="businessunit">Businessunit</label>
            <select name="businessunit" id="businessunit">
                <option value="">Alle businessunits</option>
                {% for bu in businessunits %}
                    <option value="{{ bu }}" {% if request.args.get('businessunit') == bu %}selected{% endif %}>{{ bu }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <div class="filter-field" style="min-width:140px;">
            <label for="status">Status</label>
            <select name="status" id="status">
                <option value="">Alle statussen</option>
                <option value="Ingediend" {% if request.args.get('status') == 'Ingediend' %}selected{% endif %}>Ingediend</option>
                <option value="Goedgekeurd" {% if request.args.get('status') == 'Goedgekeurd' %}selected{% endif %}>Goedgekeurd</option>
                <option value="Afgewezen" {% if request.args.get('status') == 'Afgewezen' %}selected{% endif %}>Afgewezen</option>
                <option value="In behandeling" {% if request.args.get('status') == 'In behandeling' %}selected{% endif %}>In behandeling</option>
                <option value="Afgehandeld" {% if request.args.get('status') == 'Afgehandeld' %}selected{% endif %}>Afgehandeld</option>
            </select>
        </div>
        <div class="filter-field" style="min-width:140px;">
            <label for="date_from">Begindatum</label>
            <input type="date" id="date_from" name="date_from" value="{{ request.args.get('date_from') or '' }}">
        </div>
        <div class="filter-field" style="min-width:140px;">
            <label for="date_to">Einddatum</label>
            <input type="date" id="date_to" name="date_to" value="{{ request.args.get('date_to') or '' }}">
        </div>
        <div class="filter-field" style="min-width:160px;">
            <label for="sort_order">Sortering</label>
            <select id="sort_order" name="sort_order">
                <option value="nieuwste" {% if (request.args.get('sort_order') or sort_order or 'nieuwste') == 'nieuwste' %}selected{% endif %}>Nieuwste eerst</option>
                <option value="oudste" {% if (request.args.get('sort_order') or sort_order or 'nieuwste') == 'oudste' %}selected{% endif %}>Oudste eerst</option>
            </select>
        </div>
        <div class="filter-field form-check d-flex flex-row align-items-center gap-2 flex-nowrap" style="min-width:160px;">
            <input class="form-check-input" type="checkbox" id="high_priority" name="high_priority" value="true" {% if (request.args.get('high_priority') or high_priority) %}checked{% endif %}>
            <label class="form-check-label mb-0" for="high_priority">Hoge prioriteit</label>
        </div>
        <div class="filter-field compact-btn" style="min-width:auto; margin-left:auto;">
            <button type="submit" class="action-link" style="padding:10px 16px; white-space:nowrap;">Filter</button>
        </div>
        {% if session.get('user_rol') in ['Admin', 'Key user'] %}
        <div class="filter-field compact-btn" style="min-width:auto;">
            <a href="/user/klachten/export{% if request.query_string %}?{{ request.query_string.decode('utf-8') }}{% endif %}" class="action-link" style="padding:10px 16px; white-space:nowrap;">Export CSV</a>
        </div>
        {% endif %}
    </form>

    <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    {% if klachten %}
        <table class="klachten-table">
            <thead>
                <tr>
                    <th class="col-id">ID</th>
                    <th class="col-date">Datum</th>
                    <th>Klant</th>
                    <th>Verantwoordelijke</th>
                    <th>Businessunit</th>
                    <th>Status</th>
                    <th class="col-prioriteit">Prioriteit</th>
                    <th class="col-actions">Acties</th>
                </tr>
            </thead>
            <tbody>
                {% for klacht in klachten %}
                <tr>
                    <td class="col-id"><strong>#{{ klacht.klacht_id }}</strong></td>
                    <td>
                        {% if klacht.datum_melding %}
                            {% if 'T' in klacht.datum_melding %}
                                {{ klacht.datum_melding.split('T')[0] }}
                            {% else %}
                                {{ klacht.datum_melding[:10] if klacht.datum_melding|length >= 10 else klacht.datum_melding }}
                            {% endif %}
                        {% else %}
                            Onbekend
                        {% endif %}
                    </td>
                    <td>{{ klacht.klant.klantnaam if klacht.klant else '' }}</td>
                    <td>
                        {{ (klacht.verantwoordelijke.naam if klacht.verantwoordelijke and klacht.verantwoordelijke.naam else klacht.verantwoordelijke_naam or klacht.vertegenwoordiger_naam) or '-' }}
                    </td>
                    <td>{{ klacht.businessunit or 'Onbekend' }}</td>
                    <td>
                        <span class="status-badge status-{{ klacht.status.replace(' ', '') }}">
                            {{ klacht.status }}
                        </span>
                    </td>
                    <td>
                        {% if klacht.prioriteit %}
                            <span class="priority-high">Hoog</span>
                        {% else %}
                            <span class="priority-normal">Normaal</span>
                        {% endif %}
                    </td>
                    <td class="col-actions">
                        <a href="{{ url_for('main.klacht_details', klacht_id=klacht.klacht_id) }}" class="action-link">Meer info</a>
                        <form method="POST" action="{{ url_for('main.klacht_verwijderen', klacht_id=klacht.klacht_id) }}" style="display: inline;">
                            <button type="submit" class="delete-btn" title="Verwijderen" onclick="return confirm('Weet je zeker dat je klacht #{{ klacht.klacht_id }} wilt verwijderen?')">
                                X
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% elif filters_applied %}
        <div class="no-klachten">
            <h3>Geen klachten gevonden voor deze filter</h3>
        </div>
    {% else %}
        <div class="no-klachten">
            <h3>Nog geen klachten</h3>
            <a href="{{ url_for('main.klacht_aanmaken') }}">
                <button>Eerste Klacht Aanmaken</button>
            </a>
        </div>
    {% endif %}
</div>

<script>
    const klantInput = document.getElementById('klant_filter');
    const klantHidden = document.getElementById('klant_id_filter');
    const klantList = document.getElementById('klanten_filter');
    function syncKlant() {
        if (!klantInput || !klantList) return;
        const match = Array.from(klantList.options).find(opt => opt.value === klantInput.value);
        klantHidden.value = match ? (match.dataset.id || '') : '';
    }
    if (klantInput) {
        klantInput.addEventListener('change', syncKlant);
        klantInput.addEventListener('blur', syncKlant);
    }
</script>
{% endblock %}
