{% extends "base.html" %}
{% block title %}Klacht Details{% endblock %}
{% block body_class %}page-klacht-details{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/klacht_details.css') }}">
{% endblock %}
{% block content %}
<div class="container">
    <div class="header">
        <a href="{{ url_for('main.user_klachten') }}" class="back-button">Terug naar Mijn Klachten</a>
        <h1>Klacht Details #{{ klacht_id }} - Rol: {{ session.get('user_rol') }}</h1>
    </div>

    <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% if category == 'success' %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% else %}
                        <div class="alert alert-{{ category }}" style="display:none;">{{ message }}</div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <form method="POST" action="{{ url_for('main.klacht_bewerken', klacht_id=klacht_id) }}" enctype="multipart/form-data">
        <div class="details-card">
            <div class="detail-row">
                <div class="detail-label">Klacht ID:</div>
                <div class="detail-value"><div class="readonly-field">#{{ klacht.klacht_id }}</div></div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Datum Melding:</div>
                <div class="detail-value">
                    <div class="readonly-field">
                        {% if klacht.datum_melding %}
                            {% if klacht.datum_melding %}
                                {% set datum_str = klacht.datum_melding|string %}
                                {% if 'T' in datum_str %}
                                    {{ datum_str.split('T')[0] }}
                                {% else %}
                                    {{ datum_str[:10] if datum_str|length >= 10 else datum_str }}
                                {% endif %}
                            {% else %}
                                {{ klacht.datum_melding[:10] if klacht.datum_melding|length >= 10 else klacht.datum_melding }}
                            {% endif %}
                        {% else %}Onbekend{% endif %}
                    </div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Klant:</div>
                <div class="detail-value">
                    <div class="readonly-field" style="margin-bottom:8px;">
                        {% if klacht.klant %}{{ klacht.klant.klantnaam }} (ID: {{ klacht.klant_id }}){% else %}Klant ID: {{ klacht.klant_id }}{% endif %}
                    </div>
                    <input type="text" name="klant_naam" id="klant_naam" list="klanten_datalist" value="{{ klacht.klant.klantnaam if klacht.klant else '' }}" class="edit-input" placeholder="Klant wordt auto-ingevuld bij orderselectie" required>
                    <input type="hidden" name="klant_id" id="klant_id" value="{{ klacht.klant_id or '' }}">
                    <datalist id="klanten_datalist">
                        {% for klant in klanten %}
                            <option value="{{ klant.klantnaam }}" data-id="{{ klant.klant_id }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Verantwoordelijke:</div>
                <div class="detail-value">
                    <div class="readonly-field" style="margin-bottom:8px;">
                        {% if klacht.verantwoordelijke and klacht.verantwoordelijke.get('naam') %}
                            {{ klacht.verantwoordelijke.get('naam') }}
                        {% elif klacht.vertegenwoordiger and klacht.vertegenwoordiger.get('naam') %}
                            {{ klacht.vertegenwoordiger.get('naam') }}
                        {% else %}
                            {% if klacht.verantwoordelijke_id or klacht.vertegenwoordiger_id %}Gebruiker ID: {{ klacht.verantwoordelijke_id or klacht.vertegenwoordiger_id }}{% else %}Onbekend{% endif %}
                        {% endif %}
                    </div>
                    {% if session.get('user_rol') in ['Admin', 'Key user'] and vertegenw %}
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <select name="vertegenwoordiger_id" class="edit-select">
                            <option value="">Selecteer gebruiker</option>
                            {% for r in vertegenw %}
                                <option value="{{ r.gebruiker_id }}" {% if (klacht.verantwoordelijke_id or klacht.vertegenwoordiger_id) == r.gebruiker_id %}selected{% endif %}>{{ r.naam }}{% if r.rol %} ({{ r.rol }}){% endif %}</option>
                            {% endfor %}
                        </select>
                        <!-- Toewijzen-knop verwijderd; bewaren gebeurt via de algemene Opslaan-knop onderaan -->
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Businessunit:</div>
                <div class="detail-value">
                    <div class="readonly-field" style="margin-bottom:8px;">Huidig: {{ klacht.businessunit or 'Onbekend' }}</div>
                    <select name="businessunit" class="edit-select" required>
                        <option value="">Kies businessunit</option>
                        {% for bu in businessunits %}
                            <option value="{{ bu }}" {% if klacht.businessunit == bu %}selected{% endif %}>{{ bu }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Status & prioriteit:</div>
                <div class="detail-value">
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <span class="status-badge status-{{ klacht.status.replace(' ', '') }}">{{ klacht.status }}</span>
                            {% if klacht.prioriteit %}<span class="priority-high">Hoog</span>{% else %}<span class="priority-normal">Normaal</span>{% endif %}
                        </div>
                        {% if session.get('user_rol') in ['Admin', 'Key user'] %}
                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                            <select name="status" class="edit-select" id="status_select">
                                <option value="">Wijzig status</option>
                                {% for status in status_options %}
                                    <option value="{{ status }}" {% if klacht.status == status %}selected{% endif %}>{{ status }}</option>
                                {% endfor %}
                            </select>
                            <label style="display:flex;align-items:center;gap:6px; margin-left:8px;">
                                <input type="checkbox" name="prioriteit" {% if klacht.prioriteit %}checked{% endif %}> Prioriteit
                            </label>
                        </div>
                        <div style="margin-top:8px;">
                            <label for="status_opmerking">Opmerking statuswijziging:</label>
                            <input type="text" name="status_opmerking" class="edit-input" placeholder="Korte opmerking...">
                        </div>
                        {% else %}
                        <div class="readonly-field">{{ klacht.opmerking_status_wijziging or klacht.gm_opmerking or 'Geen opmerking' }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Opmerkingen:</div>
                <div class="detail-value">
                    {% if session.get('user_rol') in ['Admin', 'Key user'] %}
                        <textarea name="opmerking" class="edit-textarea" placeholder="Interne opmerking voor deze klacht">{{ klacht.opmerking or '' }}</textarea>
                        <div style="font-size:12px; color:#6b7280; margin-top:4px;">Commentaar wordt opgeslagen bij opslaan; zichtbaar voor beheerrollen.</div>
                    {% else %}
                        <div class="readonly-field">{{ klacht.opmerking or 'Geen opmerkingen' }}</div>
                    {% endif %}
                </div>
            </div>

            {% if klacht.bijlages and klacht.bijlages|length > 0 %}
            <div class="detail-row">
                <div class="detail-label">Bijlagen:</div>
                <div class="detail-value">
                    <div id="bijlages-list">
                        {% for bijlage in klacht.bijlages %}
                            {% set bijlage_id = bijlage.get('id') if bijlage is mapping and bijlage.get('id') else loop.index %}
                            {% set bijlage_url = bijlage.get('url') if bijlage is mapping and bijlage.get('url') else (bijlage if bijlage is string else '') %}
                            {% set bijlage_naam = bijlage.get('naam') if bijlage is mapping and bijlage.get('naam') else (bijlage_url.split('/')[-1] if bijlage_url and '/' in bijlage_url else ('bijlage_' ~ loop.index)) %}
                            {% if bijlage_url %}
                            <div class="attachment-row" id="bijlage-row-{{ bijlage_id }}">
                                <div class="attachment-meta">
                                    {% set is_image = bijlage.get('is_image', False) or (bijlage_url.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.webp')) or 'image' in (bijlage.get('content_type', '') or '').lower()) %}
                                    {% if is_image %}
                                        <img src="{{ bijlage_url }}" alt="{{ bijlage_naam }}" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover; cursor: pointer;" onclick="window.open('{{ bijlage_url }}', '_blank')" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <a href="{{ bijlage_url }}" target="_blank" style="display:none;" class="attachment-link">{{ bijlage_naam }}</a>
                                    {% else %}
                                        <a href="{{ bijlage_url }}" target="_blank" aria-label="Open bijlage {{ bijlage_naam }}" class="attachment-link">{{ bijlage_naam }}</a>
                                    {% endif %}
                                </div>
                                <div class="attachment-actions">
                                    <button type="button" class="delete-btn" onclick="toggleDelete('{{ bijlage_id }}')">Verwijderen</button>
                                    <button type="button" class="undo-btn" style="display:none;" onclick="toggleDelete('{{ bijlage_id }}', true)">Ongedaan</button>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="detail-row">
                <label class="detail-label" for="new_bijlages">Nieuwe Bijlages:</label>
                <div class="detail-value">
                    <input id="new_bijlages" name="new_bijlages" type="file" accept="image/*,application/pdf" multiple class="edit-input">
                    <div style="font-size: 13px; color: #6b7280; margin-top: 6px;">Accepteert afbeeldingen en PDF-bestanden.</div>
                </div>
            </div>
            <input type="hidden" name="deleted_bijlages" id="deleted_bijlages" value="">

            <div class="detail-row">
                <div class="detail-label">Ordernummer:</div>
                <div class="detail-value">
                    <input type="text" name="order_nummer" id="order_nummer" list="orders_datalist" value="{{ klacht.order_nummer or '' }}" class="edit-input" placeholder="Kies ordernummer" required>
                    <datalist id="orders_datalist">
                        {% for order in orders %}
                            <option value="{{ order.order_nummer }}" data-klantid="{{ order.klant_id or '' }}" data-klantnaam="{{ order.klantnaam or '' }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Artikelnummer:</div>
                <div class="detail-value">
                    <input type="text" name="artikelnummer" id="artikelnummer" list="producten_datalist" value="{{ klacht.artikelnummer or '' }}" class="edit-input" placeholder="Kies artikelnummer" required>
                    <datalist id="producten_datalist">
                        {% for product in producten %}
                            <option value="{{ product.artikel_nr }}" label="{{ product.naam }}" data-name="{{ product.naam }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
            </div>

            

            <div class="detail-row">
                <div class="detail-label">Aantal eenheden:</div>
                <div class="detail-value">
                    <input type="number" min="1" step="1" name="aantal_eenheden" value="{{ klacht.aantal_eenheden or '' }}" class="edit-input" placeholder="Aantal" required>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Categorie:</div>
                <div class="detail-value">
                    <select name="categorie_id" class="edit-select" required>
                        {% for categorie in categorieen %}
                            <option value="{{ categorie.categorie_id }}" {% if klacht.categorie_id == categorie.categorie_id %}selected{% endif %}>
                                {{ categorie.type }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Mogelijke oorzaak:</div>
                <div class="detail-value">
                    <textarea name="mogelijke_oorzaak" class="edit-textarea" placeholder="Beschrijf de mogelijke oorzaak">{{ klacht.mogelijke_oorzaak or '' }}</textarea>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Klacht omschrijving:</div>
                <div class="detail-value">
                    <textarea name="reden_afwijzing" class="edit-textarea" placeholder="Omschrijf de klacht" required>{{ klacht.klacht_omschrijving or klacht.reden_afwijzing or '' }}</textarea>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Ondernemingsnummer klant:</div>
                <div class="detail-value">
                    <div class="readonly-field">
                        {% if klacht.klant %}{{ klacht.klant.ondernemingsnummer or 'Onbekend' }}{% else %}Onbekend{% endif %}
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="save-btn">Opslaan</button>
                <a href="{{ url_for('main.klacht_details', klacht_id=klacht_id) }}" class="cancel-btn">Annuleren</a>
            </div>
        </div>
    </form>

    <div class="details-card" style="margin-top: 20px;">
        <h2>Status Historiek</h2>
                {% if statushistoriek %}
            <ul style="list-style:none; padding-left:0;">
            {% for sh in statushistoriek %}
                <li style="padding:8px 0; border-bottom:1px solid #e5e7eb;">
                    {% set raw_date = sh.datum_wijziging_local or sh.datum_wijziging or '' %}
                    {% set clean_date = raw_date.split('T')[0].split(' ')[0] %}
                    <strong>{{ clean_date }}</strong>
                    - {{ sh.oude_status }} -> {{ sh.nieuwe_status }}
                    {% if sh.opmerking %}
                        <div style="font-size: 12px; color:#374151; margin-top:4px;">{{ sh.opmerking }}</div>
                    {% endif %}
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <div style="color:#6b7280;">Nog geen wijzigingen</div>
        {% endif %}
    </div>
</div>

<script>
    // Popups
    document.addEventListener('DOMContentLoaded', function() {
        const flashMessages = document.querySelectorAll('.alert');
        flashMessages.forEach(function(msg) {
            const text = msg.textContent.trim();
            const isSuccess = msg.classList.contains('alert-success');
            
            if (text && !isSuccess) {
                alert(text);
            }
        });
    });

    function syncOrderSelection() {
        const orderInput = document.getElementById('order_nummer');
        const orderDatalist = document.getElementById('orders_datalist');
        const klantNaamInput = document.getElementById('klant_naam');
        const klantIdHidden = document.getElementById('klant_id');
        
        if (!orderInput || !orderDatalist || !klantNaamInput || !klantIdHidden) return false;

        const match = Array.from(orderDatalist.options).find(opt => String(opt.value) === String(orderInput.value));
        if (match) {
            // Auto-fill klant
            const kid = match.dataset.klantid || '';
            const kname = match.dataset.klantnaam || '';
            klantIdHidden.value = kid;
            if (klantNaamInput) {
                klantNaamInput.value = kname;
            }
            return true;
        } else {
            
            klantIdHidden.value = '';
            return false;
        }
    }

    function handleKlantChange() {
        const klantNaamInput = document.getElementById('klant_naam');
        const klantIdHidden = document.getElementById('klant_id');
        const klantDatalist = document.getElementById('klanten_datalist');
        if (!klantNaamInput || !klantIdHidden || !klantDatalist) return;

        const matchKlant = Array.from(klantDatalist.options).find(opt => opt.value === klantNaamInput.value);
        const formKlantId = matchKlant ? (matchKlant.dataset.id || '') : '';

        
        klantIdHidden.value = formKlantId || '';
    }

    function toggleDelete(bijlageId, forceUndo) {
        const row = document.getElementById('bijlage-row-' + bijlageId);
        if (!row) return;
        const deleteBtn = row.querySelector('.delete-btn');
        const undoBtn = row.querySelector('.undo-btn');
        const hidden = document.getElementById('deleted_bijlages');
        const alreadyDeleted = row.classList.contains('deleted-attachment');
        let newDeletedState = forceUndo ? false : !alreadyDeleted;
        if (newDeletedState) {
            row.classList.add('deleted-attachment');
            deleteBtn.style.display = 'none';
            undoBtn.style.display = 'inline-block';
        } else {
            row.classList.remove('deleted-attachment');
            deleteBtn.style.display = 'inline-block';
            undoBtn.style.display = 'none';
        }
        const current = hidden.value ? hidden.value.split(',').filter(Boolean) : [];
        const idx = current.indexOf(String(bijlageId));
        if (newDeletedState && idx === -1) current.push(String(bijlageId));
        if (!newDeletedState && idx !== -1) current.splice(idx, 1);
        hidden.value = current.join(',');
    }
    (function() {
        const form = document.querySelector('form[enctype="multipart/form-data"]');
        const statusSelect = document.getElementById('status_select');
        const orderInput = document.getElementById('order_nummer');
        const orderDatalist = document.getElementById('orders_datalist');
        const artikelInput = document.getElementById('artikelnummer');
        const productenDatalist = document.getElementById('producten_datalist');
        const klantNaamInput = document.getElementById('klant_naam');
        const klantIdHidden = document.getElementById('klant_id');
        const klantDatalist = document.getElementById('klanten_datalist');
        
        if (!form) return;
        
        
        if (orderInput) {
            orderInput.addEventListener('change', syncOrderSelection);
            orderInput.addEventListener('blur', syncOrderSelection);
        }

        function syncKlantSelection() {
            if (!klantNaamInput || !klantDatalist || !klantIdHidden) return;
            const match = Array.from(klantDatalist.options).find(opt => opt.value === klantNaamInput.value);
            if (match) {
                klantIdHidden.value = match.dataset.id || '';
            } else {
                klantIdHidden.value = '';
            }
        }

        if (klantNaamInput) {
            klantNaamInput.addEventListener('change', syncKlantSelection);
            klantNaamInput.addEventListener('blur', syncKlantSelection);
        }
        
        form.addEventListener('submit', function(e) {
            let isValid = true;
            
            const hidden = document.getElementById('deleted_bijlages');
            if (hidden && hidden.value) {
                const confirmed = confirm('Er zijn bijlagen gemarkeerd om te verwijderen. Doorgaan?');
                if (!confirmed) { e.preventDefault(); return false; }
            }
            
            
            if (orderInput && orderDatalist && orderInput.value) {
                const matchOrder = Array.from(orderDatalist.options).find(opt => String(opt.value) === String(orderInput.value));
                if (!matchOrder) {
                    isValid = false;
                    alert('Kies een bestaand ordernummer uit de lijst.');
                }
            }
            
            
            if (artikelInput && productenDatalist && artikelInput.value) {
                const matchArt = Array.from(productenDatalist.options).find(opt => String(opt.value) === String(artikelInput.value));
                if (!matchArt) {
                    isValid = false;
                    alert('Kies een bestaand artikelnummer uit de lijst.');
                }
            }

            
            if (orderInput && orderDatalist && orderInput.value && klantIdHidden && klantIdHidden.value) {
                const matchOrder = Array.from(orderDatalist.options).find(opt => String(opt.value) === String(orderInput.value));
                if (matchOrder) {
                    const orderKlantId = matchOrder.dataset.klantid || '';
                    if (orderKlantId && String(orderKlantId) !== String(klantIdHidden.value)) {
                        isValid = false;
                        alert('Geselecteerde klant komt niet overeen met klant van het ordernummer. Kies een klant die bij het order hoort.');
                    }
                }
            }
            
            
            if (!isValid) {
                e.preventDefault();
                return false;
            }
        });
    })();
</script>
{% endblock %}

