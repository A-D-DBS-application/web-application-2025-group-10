{% extends "base.html" %}
{% block title %}Klacht Details{% endblock %}
{% block body_class %}page-klacht-details{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/klacht_details.css') }}">
{% endblock %}
{% block content %}
<div class="container">
    <div class="header">
        <a href="{{ url_for('main.user_klachten') }}" class="back-button">Terug naar Mijn Klachten</a>
        <h1>Klacht Details #{{ klacht_id }} - Rol: {{ session.get('user_rol') }}</h1>
    </div>

    <form method="POST" action="{{ url_for('main.klacht_bewerken', klacht_id=klacht_id) }}" enctype="multipart/form-data">
        <div class="details-card">
            <div class="detail-row">
                <div class="detail-label">Klacht ID:</div>
                <div class="detail-value"><div class="readonly-field">#{{ klacht.klacht_id }}</div></div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Datum Melding:</div>
                <div class="detail-value">
                    <div class="readonly-field">
                        {% if klacht.datum_melding %}
                            {% if 'T' in klacht.datum_melding %}
                                {{ klacht.datum_melding.split('T')[0] }}
                            {% else %}
                                {{ klacht.datum_melding[:10] if klacht.datum_melding|length >= 10 else klacht.datum_melding }}
                            {% endif %}
                        {% else %}Onbekend{% endif %}
                    </div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Klant:</div>
                <div class="detail-value">
                    <div class="readonly-field">
                        {% if klacht.klant %}{{ klacht.klant.klantnaam }} (ID: {{ klacht.klant_id }}){% else %}Klant ID: {{ klacht.klant_id }}{% endif %}
                    </div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Verantwoordelijke:</div>
                <div class="detail-value">
                    <div class="readonly-field" style="margin-bottom:8px;">
                        {% if klacht.verantwoordelijke and klacht.verantwoordelijke.get('naam') %}
                            {{ klacht.verantwoordelijke.get('naam') }}
                        {% elif klacht.vertegenwoordiger and klacht.vertegenwoordiger.get('naam') %}
                            {{ klacht.vertegenwoordiger.get('naam') }}
                        {% else %}
                            {% if klacht.verantwoordelijke_id or klacht.vertegenwoordiger_id %}Gebruiker ID: {{ klacht.verantwoordelijke_id or klacht.vertegenwoordiger_id }}{% else %}Onbekend{% endif %}
                        {% endif %}
                    </div>
                    {% if session.get('user_rol') in ['Admin', 'Key user'] and vertegenw %}
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <select name="vertegenwoordiger_id" class="edit-select">
                            <option value="">Selecteer gebruiker</option>
                            {% for r in vertegenw %}
                                <option value="{{ r.gebruiker_id }}" {% if (klacht.verantwoordelijke_id or klacht.vertegenwoordiger_id) == r.gebruiker_id %}selected{% endif %}>{{ r.naam }}{% if r.rol %} ({{ r.rol }}){% endif %}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="save-btn" formaction="{{ url_for('main.keyuser_assign_klacht', klacht_id=klacht_id) }}" formmethod="POST" formnovalidate>Toewijzen</button>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Businessunit:</div>
                <div class="detail-value">
                    <div class="readonly-field" style="margin-bottom:8px;">Huidig: {{ klacht.businessunit or 'Onbekend' }}</div>
                    <select name="businessunit" class="edit-select" required>
                        <option value="">Kies businessunit</option>
                        {% for bu in businessunits %}
                            <option value="{{ bu }}" {% if klacht.businessunit == bu %}selected{% endif %}>{{ bu }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Status & prioriteit:</div>
                <div class="detail-value">
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <span class="status-badge status-{{ klacht.status.replace(' ', '') }}">{{ klacht.status }}</span>
                            {% if klacht.prioriteit %}<span class="priority-high">Hoog</span>{% else %}<span class="priority-normal">Normaal</span>{% endif %}
                        </div>
                        {% if session.get('user_rol') in ['Admin', 'Key user'] %}
                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                            <select name="status" class="edit-select" id="status_select">
                                <option value="">Wijzig status</option>
                                {% set disallowed_statuses = ['Goedgekeurd', 'Afgewezen'] %}
                                {% for status in status_options %}
                                    {% if status not in disallowed_statuses %}
                                        <option value="{{ status }}" {% if klacht.status == status %}selected{% endif %}>{{ status }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <label style="display:flex;align-items:center;gap:6px; margin-left:8px;">
                                <input type="checkbox" name="prioriteit" {% if klacht.prioriteit %}checked{% endif %}> Prioriteit
                            </label>
                        </div>
                        <div style="margin-top:8px;">
                            <label for="status_opmerking">Opmerking statuswijziging:</label>
                            <input type="text" name="status_opmerking" class="edit-input" placeholder="Korte opmerking...">
                        </div>
                        {% else %}
                        <div class="readonly-field">{{ klacht.opmerking_status_wijziging or klacht.gm_opmerking or 'Geen opmerking' }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Opmerkingen:</div>
                <div class="detail-value">
                    {% if session.get('user_rol') in ['Admin', 'Key user'] %}
                        <textarea name="opmerking" class="edit-textarea" placeholder="Interne opmerking voor deze klacht">{{ klacht.opmerking or '' }}</textarea>
                        <div style="font-size:12px; color:#6b7280; margin-top:4px;">Commentaar wordt opgeslagen bij opslaan; zichtbaar voor beheerrollen.</div>
                    {% else %}
                        <div class="readonly-field">{{ klacht.opmerking or 'Geen opmerkingen' }}</div>
                    {% endif %}
                </div>
            </div>

            {% if klacht.bijlages %}
            <div class="detail-row">
                <div class="detail-label">Bijlagen:</div>
                <div class="detail-value">
                    <div id="bijlages-list">
                        {% for bijlage in klacht.bijlages %}
                            {% set bijlage_id = bijlage.get('id') if bijlage is mapping and bijlage.get('id') else loop.index %}
                            {% set bijlage_url = bijlage.get('url') if bijlage is mapping and bijlage.get('url') else (bijlage if bijlage is string else '') %}
                            {% set bijlage_naam = bijlage.get('naam') if bijlage is mapping and bijlage.get('naam') else (bijlage_url.split('/')[-1] if bijlage_url and '/' in bijlage_url else ('bijlage_' ~ loop.index)) %}
                            <div class="attachment-row" id="bijlage-row-{{ bijlage_id }}">
                                <div class="attachment-meta">
                                    <a href="{{ bijlage_url }}" target="_blank" aria-label="Open bijlage {{ bijlage_naam }}" class="attachment-link">{{ bijlage_naam }}</a>
                                    <div style="font-size: 12px; color: #6b7280; word-break: break-all;">{{ bijlage_url }}</div>
                                </div>
                                <div class="attachment-actions">
                                    <button type="button" class="delete-btn" onclick="toggleDelete('{{ bijlage_id }}')">Verwijderen</button>
                                    <button type="button" class="undo-btn" style="display:none;" onclick="toggleDelete('{{ bijlage_id }}', true)">Ongedaan</button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="detail-row">
                <label class="detail-label" for="new_bijlages">Nieuwe Bijlages:</label>
                <div class="detail-value">
                    <input id="new_bijlages" name="new_bijlages" type="file" accept="image/*,application/pdf" multiple class="edit-input">
                    <div style="font-size: 13px; color: #6b7280; margin-top: 6px;">Accepteert afbeeldingen en PDF-bestanden.</div>
                </div>
            </div>
            <input type="hidden" name="deleted_bijlages" id="deleted_bijlages" value="">

            <div class="detail-row">
                <div class="detail-label">Ordernummer:</div>
                <div class="detail-value">
                    <input type="text" name="order_nummer" value="{{ klacht.order_nummer or '' }}" class="edit-input" placeholder="Voer ordernummer in" required>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Artikelnummer:</div>
                <div class="detail-value">
                    <input type="text" name="artikelnummer" value="{{ klacht.artikelnummer or '' }}" class="edit-input" placeholder="Voer artikelnummer in" required>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Artikelnaam (voor nieuwe nummers):</div>
                <div class="detail-value">
                    <input type="text" name="artikel_naam" value="{{ klacht.artikel_naam or '' }}" class="edit-input" placeholder="Optioneel: artikelnaam">
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Aantal eenheden:</div>
                <div class="detail-value">
                    <input type="number" min="1" step="1" name="aantal_eenheden" value="{{ klacht.aantal_eenheden or '' }}" class="edit-input" placeholder="Aantal" required>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Categorie:</div>
                <div class="detail-value">
                    <select name="categorie_id" class="edit-select" required>
                        {% for categorie in categorieen %}
                            <option value="{{ categorie.categorie_id }}" {% if klacht.categorie_id == categorie.categorie_id %}selected{% endif %}>
                                {{ categorie.type }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Mogelijke oorzaak:</div>
                <div class="detail-value">
                    <textarea name="mogelijke_oorzaak" class="edit-textarea" placeholder="Beschrijf de mogelijke oorzaak">{{ klacht.mogelijke_oorzaak or '' }}</textarea>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Klacht omschrijving:</div>
                <div class="detail-value">
                    <textarea name="reden_afwijzing" class="edit-textarea" placeholder="Omschrijf de klacht" required>{{ klacht.klacht_omschrijving or klacht.reden_afwijzing or '' }}</textarea>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Ondernemingsnummer klant:</div>
                <div class="detail-value">
                    <div class="readonly-field">
                        {% if klacht.klant %}{{ klacht.klant.ondernemingsnummer or 'Onbekend' }}{% else %}Onbekend{% endif %}
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="save-btn">Opslaan</button>
                <a href="{{ url_for('main.klacht_details', klacht_id=klacht_id) }}" class="cancel-btn">Annuleren</a>
            </div>
        </div>
    </form>

    <div class="details-card" style="margin-top: 20px;">
        <h2>Status Historiek</h2>
                {% if statushistoriek %}
            <ul style="list-style:none; padding-left:0;">
            {% for sh in statushistoriek %}
                <li style="padding:8px 0; border-bottom:1px solid #e5e7eb;">
                    {% set raw_date = sh.datum_wijziging_local or sh.datum_wijziging or '' %}
                    {% set clean_date = raw_date.split('T')[0].split(' ')[0] %}
                    <strong>{{ clean_date }}</strong>
                    - {{ sh.oude_status }} -> {{ sh.nieuwe_status }}
                    {% if sh.opmerking %}
                        <div style="font-size: 12px; color:#374151; margin-top:4px;">{{ sh.opmerking }}</div>
                    {% endif %}
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <div style="color:#6b7280;">Nog geen wijzigingen</div>
        {% endif %}
    </div>
</div>

<script>
    function toggleDelete(bijlageId, forceUndo) {
        const row = document.getElementById('bijlage-row-' + bijlageId);
        if (!row) return;
        const deleteBtn = row.querySelector('.delete-btn');
        const undoBtn = row.querySelector('.undo-btn');
        const hidden = document.getElementById('deleted_bijlages');
        const alreadyDeleted = row.classList.contains('deleted-attachment');
        let newDeletedState = forceUndo ? false : !alreadyDeleted;
        if (newDeletedState) {
            row.classList.add('deleted-attachment');
            deleteBtn.style.display = 'none';
            undoBtn.style.display = 'inline-block';
        } else {
            row.classList.remove('deleted-attachment');
            deleteBtn.style.display = 'inline-block';
            undoBtn.style.display = 'none';
        }
        const current = hidden.value ? hidden.value.split(',').filter(Boolean) : [];
        const idx = current.indexOf(String(bijlageId));
        if (newDeletedState && idx === -1) current.push(String(bijlageId));
        if (!newDeletedState && idx !== -1) current.splice(idx, 1);
        hidden.value = current.join(',');
    }
    (function() {
        const form = document.querySelector('form[enctype="multipart/form-data"]');
        const statusSelect = document.getElementById('status_select');
        if (!form) return;
        form.addEventListener('submit', function(e) {
            const hidden = document.getElementById('deleted_bijlages');
            if (hidden && hidden.value) {
                const confirmed = confirm('Er zijn bijlagen gemarkeerd om te verwijderen. Doorgaan?');
                if (!confirmed) { e.preventDefault(); return false; }
            }
            if (statusSelect && statusSelect.value === 'Afgewezen') {
                const sure = confirm('Zeker dat je deze klacht wilt afwijzen?');
                if (!sure) { e.preventDefault(); return false; }
            }
        });
    })();
</script>
{% endblock %}
